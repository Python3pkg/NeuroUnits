
\documentclass{article}


\usepackage{verbatim} 
\usepackage{listings} 
\usepackage[usenames,dvipsnames]{color}
\usepackage[margin=2cm]{geometry}
%\usepackage{alltt}
\usepackage{syntax}
\usepackage{amsmath}


\title{Proposal for a  grammar for units and expression involving units in computational neuroscience}
\author{Michael Hull}


\lstset{% general command to set parameter(s)
basicstyle=\footnotesize, % print whole listing small
keywordstyle=\color{blue}, %\bfseries\underbar,
identifierstyle=, % nothing happens
commentstyle=\color{OliveGreen}, % white comments
stringstyle=\ttfamily, % typewriter type for strings
showstringspaces=false, % no special string spaces
language=python,
frame=lines,
float=tbfh}

\begin{document}
\maketitle

\tableofcontents

\section{Motivation}

Computational neuroscience is a field with a large 
array of tools aimed at specific tasks. Recently, 
there has been a focus on tool interoperability. 
Unfortunately, many different tools use different 
notations for unit handling.\\


In general, the parsing of expressions involving units and constants is tricky. For example the expression
\verb| val = 1 K / F | could mean 'one-kelvin-per-Farad' or it could be 'one-kelvin-divided by the gas constant. \\

We propose a simple, unambiguous, ascii-string based format for denoting quantities with units, and 
simple expressions involving these quantities, which can be implemented with standard parsing tools. 
Moreover, the syntax means that implementers do not need to implement the complete expression parsing grammar 
and instead only implement the part they require. Particular emphasises are human readbility, extensibility and 
inter-operability with existing conventions.



\newpage
\section{Review  of unit definition in existing tools}

\subsection*{Neuron}
NEURON separates the simulation process into two parts; .hoc and .mod files. The units that a particular parameter will be specified in are specified in .mod files. NEURON comes with a database of units and constants, derived from the GNU units packages, found in 'nrnunits.lib'. New units and constants can also be defined in terms of old units. E.G. The commandline tool 'modlunits' can be used to check for consistency in a mod-file.

\subsection*{Genesis}
TOCHECK: It appears to me that units in genesis are all specified using SI base units. But  I am not a genesis user - is this true??


\subsection*{SBML}
SBML is an XML format for Systems Biology. New unit definitions can built from builtin types (or existing definitions, I thinkk!?).
For example

\begin{lstlisting}

<unitDefinition id="litre_per_mole_per_second">
                <listOfUnits>
                    <unit kind="mole"   exponent="-1"/>
                    <unit kind="litre"  exponent="1"/>
                    <unit kind="second" exponent="-1"/>
                </listOfUnits>
</unitDefinition>
\end{lstlisting}



\subsection*{BRIAN}
BRIAN allows the specification of units in python code, by writing for example:

\begin{lstlisting}
from brian import *
tau = 20 * msecond        # membrane time constant
Vt = -50 * mvolt          # spike threshold
Vr = -60 * mvolt          # reset value
\end{lstlisting}

and allows validation of expected unit types by writing:
\begin{lstlisting}
model='dV/dt = -(V-El)/tau : volt'
\end{lstlisting}


\subsection*{GNU units}




\newpage
\section{Proposed requirements} 
\subsection{Use cases}
Use-cases:

\begin{description}
\item[Simulation configuation:]
Most simulators either allow direct access to thier API through a programming language, or read simulation configurations in from files. The a flexible specification for units would be an inline ascii-string.  For example, to specify a leak channel, we would like to be able to write:
\begin{lstlisting}
create_leak_channel(reversal_potential="-70 mV", conductance="3 pS/cm2")
\end{lstlisting}
or, to make comparisons with anatomy and physiology easier,
\begin{lstlisting}
create_leak_channel(reversal_potential="-70 mV", conductance="(1/300 MOhm)/(500um2)")
\end{lstlisting}


\item[Loading \& storing of data \& results:] 


Often, data is stored in an intermediate format between tools, either in text files (eg. .csv files), or in binary files, (.mat) files. 

\begin{verbatim}
# My CSV FILE
# COLUMN0: {'label':'t', 'unit':'ms' }
# COLUMN1: {'label':'membrane_voltage', 'unit':'mV' }
0.000, -75.000
0.010, -75.000
0.020, -75.000
0.030, -75.000
\end{verbatim}


\item[In specification of functions and formulae]
Needing to divide by m or V to use activation curves.

\item[In reuse of equations]


\end{description}



\subsection{Constraints}
\begin{description}
\item[Scope] Neuroscience specific, we don't want to have to redefine 'V' each time, but we want to be able to express any unit.
\item[Readability] Neuroscience specific. Human readable 
\item[Implementation] Easy to do for adoption. Needs to be simple to implement parsers: tricky cases: 'g'(gravity,gram), 'e', spellings of 'meter', 'F' (farad/gas constants)
Amount of things an implementation has to implement.
\end{description}

\subsection{Example Formula}
\begin{description}
\item NMDA? Cellular concentrations.
\end{description}

\newpage
\section{Proposal}

\subsection{Overview}
Definitions of units, expressions, unitdefinitons
Examples

Use of colon


\subsection{Syntax Limitations}
Use of numbers in variable names

\subsection*{Note about Preceedence}
Multiplication can be funny, and division.



\newpage
\subsection{Proposed Builtins}


\subsubsection{Mathematical Constants}
\begin{center}
    \begin{tabular}{ | l | l |  l | p{5cm} |}
    \hline
    Symbol & Value & Units & Description  \\ \hline
    pi & 3.141 & - & Radians in a circle \\ \hline
    e\_euler & - & - & - \\ \hline
    \end{tabular}
\end{center}

\subsubsection{Mathematical Functions}
\begin{center}
    \begin{tabular}{ | l |  p{5cm} |}
    \hline
    Signature &  Description  \\ \hline
    log2 & {...} \\ \hline
    log10 & {...} \\ \hline
    \end{tabular}
\end{center}


\subsubsection{Multipliers}


\begin{center}
    \begin{tabular}{ | l | l |  l | p{5cm} |}
    \hline
    long-form & short-form & value  \\ \hline
    giga & G & $10^9$ \\ \hline
    mega & M & $10^6$ \\ \hline
    kilo & k & $10^3$ \\ \hline
    centi & c & $10^{-2}$ \\ \hline
    milli & m & $10^{-3}$ \\ \hline
    micro & u & $10^{-6}$ \\ \hline
    nano & n & $10^{-9}$ \\ \hline
    pico & p & $10^{-12}$ \\ \hline
    \end{tabular}
\end{center}


\subsubsection{Base units}

\begin{center}
    \begin{tabular}{ | l | l |  l | p{5cm} |}
    \hline
    long-form & short-form & value  \\ \hline
    meter & m & - \\ \hline
    gram & g & - \\ \hline
    second & s & - \\ \hline
    ampere & A & - \\ \hline
    kelvin & K & - \\ \hline
    mole & mol & - \\ \hline
    candela & cd & - \\ \hline
    \end{tabular}
\end{center}

\subsubsection{Builtin Derived Units}

\begin{center}
    \begin{tabular}{ | l | l |  l | p{5cm} |}
    \hline
    long-form & short-form & base-units  \\ \hline
    volt & V & - \\ \hline
    siemen & S & - \\ \hline
    farad & F & - \\ \hline
    coulomb & C & - \\ \hline
    hertz & Hz & - \\ \hline
    ohm & Ohm & - \\ \hline
    watt & W & - \\ \hline
    joule & J & - \\ \hline
    newton & N & - \\ \hline
    liter & l & - \\ \hline
    BLAH & BLAH & - \\ \hline
    \end{tabular}
\end{center}


\newpage
\subsection{Parsing Algorithm}

Parsing units is not a trivial process. Unfortunately, whitespace plays an important role, and the overlap of the symbol 'm' in the multipliers and base units complicates the grammar. However, it is still quite simple using 2 stage parsing stages, one to handle epxressions, and the other to parse individual unit terms:


\subsubsection{Preprocessing}

White space is very important in interpreting these equations. We apply the following regular expressions to simplify the parsing grammar.

\begin{description}
\item[Strip unnessesary whitespace] \hfill \\
Remove all the whitespace surrounding the symbols: \verb@ + ( ) / * :@  \\
\verb@"[ \t]* ([()/*:+]) [ \t]*"@ $\rightarrow$ \verb@"\1"@

\item[Substitute Division Sign] \hfill \\
Since \verb@/@ plays two roles, either division of unit-terms (eg mV/pS) or division of
quantity terms (1mV/1pS), we remap the division of unit terms to '//' \\
\verb@"/(?= [(]* (?:[a-zA-Z]) )"@ $\rightarrow$ \verb@"//"@ \\
\verb@"/(?= [(]* (?:{~) )"@ $\rightarrow$ \verb@"//"@

\item[Substitute Subtraction Signs] \hfill \\
Similarly, \verb@-@ can play three roles, either in an unit term (eg kg-2 m), as a subtraction
operator (1mV - 1V) or as a numerical modifier (1mV + -1mV) \\
\verb@"[ ]* [-](?=[^0-9]) [ ]*"@ $\rightarrow$ \verb@"--"@

\end{description}


\subsubsection{Expression Lexing Tokens}

{\scriptsize
\begin{equation}
\begin{aligned}
\verb!NO_UNITS!       & \verb! := !       \verb!NO_UNIT! \\
\verb!INTEGER!        & \verb! := !       \verb![+-]?[0-9]+! \\
\verb!FLOAT!          & \verb! := !       \verb![-]?[0-9]+\.[0-9]*([eE][+-]?[0-9]+)?! \\
\verb!ALPHATOKEN!     & \verb! := !       \verb![a-zA-Z_]+! \\
\verb!SLASHSLASH!     & \verb! := !       \verb!//!\\
\verb!SLASH!          & \verb! := !       \verb!/!\\
\verb!WHITESPACE!     & \verb! := !       \verb![ \t]+"""!\\
\verb!LBRACKET!       & \verb! := !       \verb!\(!\\
\verb!RBRACKET!       & \verb! := !       \verb!\)!\\
\verb!LCURLYBRACKET!  & \verb! := !       \verb!\{!\\
\verb!RCURLYBRACKET!  & \verb! := !       \verb!\}!\\
\verb!EXCLAIMATION!   & \verb! := !       \verb@!@\\
\verb!TILDE!          & \verb! := !       \verb!~!\\
\verb!TIMES!          & \verb! := !       \verb!\*!\\
\verb!PLUS!           & \verb! := !       \verb!\+!\\
\verb!COMMA!          & \verb! := !       \verb!,!\\
\verb!COLON!          & \verb! := !       \verb!:!\\
\verb!EQUALS!         & \verb! := !       \verb!=!
\end{aligned}
\end{equation}
}


\setlength{\grammarparsep}{20pt plus 1pt minus 1pt} % increase separation between rules
\setlength{\grammarparsep}{15pt} % increase separation between rules
\setlength{\grammarindent}{12em} % increase separation between LHS/RHS 

\newpage
\subsubsection{Expression Grammar BNF}

This is a high level grammar, which parses expressions. The term in "unit\_term\_unpowered" 
need to be parsed onto the next parser, since the parsing of individual unit terms requires a 
separate lookup term to resolve the ambiguity between 'm' in milli or meter.

{\scriptsize
\begin{grammar}

<unit\_term\_unpowered> ::= ALPHATOKEN

<unit\_term> ::= <unit\_term\_unpowered>
\alt <unit\_term\_unpowered> INTEGER
\alt LCURLYBRACKET TILDE ALPHTOKEN RCURLYBRACKET

<unit\_term\_grp> ::= <unit\_term>
\alt <unit\_term\_grp> WHITESPACE <unit\_term>

<parameterised\_unit\_term> ::= LBRACKET <unit\_term\_grp> RBRACKET
\alt LBRACKET <unit\_term\_grp> SLASHSLASH <unit\_term\_grp> RBRACKET


<unit\_expr> ::= <unit\_term\_grp>
\alt <unit\_term\_grp> SLASHSLASH <unit\_term\_grp>
\alt <parameterised\_unit\_term> SLASHSLASH <parameterised\_unit\_term>
\alt <unit\_term\_grp> SLASHSLASH <parameterised\_unit\_term>
\alt <parameterised\_unit\_term> SLASHSLASH <unit\_term\_grp>
\alt <parameterised\_unit\_term>


<quantity> ::= magnitude
\alt <magnitude> <unit\_expr>
\alt <magnitude> WHITESPACE <unit\_expr>
\alt LCURLYBRACKET <constant> RCURLYBRACKET 
\alt NO\_UNIT LCURLYBRACKET quantity\_expr RCURLYBRACKET 

<constant> ::= ALPHATOKEN 

<magnitude> ::= FLOAT 
\alt INTEGER

<quantity\_expr> : <quantity\_expr> PLUS <quantity\_term>
\alt : <quantity\_expr> MINUSMINUS <quantity\_term>
\alt : <quantity\_term>

<quantity\_term> :  <quantity\_term> TIMES <quantity\_factor>
\alt : <quantity\_term> SLASH <quantity\_factor>
\alt : <quantity\_factor>

<quantity\_factor> : <quantity> 
\alt LBRACKET <quantity\_expr> RBRACKET 

<func\_call\_param> : ALPHATOKEN EQUALS quantity\_expr>
<func\_call\_params> : quantity\_expr>
\alt <func\_call\_param> 
\alt <func\_call\_params> COMMA <func\_call\_param>

<function\_def> : ALPHATOKEN LBRACKET <function\_def\_params> RBRACKET EQUALS <quantity\_expr>

<function\_def\_params> : ALPHATOKEN
\alt ALPHATOKEN COLON <unit\_expr>
\alt <function\_params> COMMA ALPHATOKEN

\end{grammar}
}


\newpage
\subsubsection{Token-Parsing Grammar BNF}

The "unit\_term\_unpowered" also requires an additional lookup step. If the 
unit is 'm,cm,um,....', then the unit should be resolved as the relevant unit directly.

{\scriptsize
\begin{grammar}
<unit\_term\_unpowered> ::=  <short\_basic\_unit> 
\alt <long\_basic\_unit>
\alt <SPECIAL-SEE TEXT>

<unit\_term\_unpowered> ::=  <long\_basic\_multiplier> <long\_basic\_unit>
\alt <short\_basic\_multiplier> <short\_basic\_unit> 

<long\_basic\_unit> ::=  LONG\_VOLT 
\alt LONG\_AMP 
\alt LONG\_SIEMEN
\alt LONG\_OHM
\alt LONG\_COULOMB
\alt LONG\_FARAD
\alt LONG\_METER
\alt LONG\_GRAM
\alt LONG\_SECOND
\alt LONG\_KELVIN
\alt LONG\_MOLE
\alt LONG\_CANDELA

<short\_basic\_unit> ::= SHORT\_VOLT 
\alt SHORT\_AMP 
\alt SHORT\_SIEMEN
\alt SHORT\_OHM
\alt SHORT\_COULOMB
\alt SHORT\_FARAD
\alt SHORT\_METER
\alt SHORT\_GRAM
\alt SHORT\_SECOND
\alt SHORT\_KELVIN
\alt SHORT\_MOLE
\alt SHORT\_CANDELA

<long\_basic\_multiplier> ::=  LONG\_GIGA 
\alt LONG\_MEGA 
\alt LONG\_KILO
\alt LONG\_CENTI
\alt LONG\_MILLI
\alt LONG\_MICRO
\alt LONG\_NANO
\alt LONG\_PICO

<short\_basic\_multiplier> ::=   SHORT\_GIGA 
\alt SHORT\_MEGA                           
\alt SHORT\_KILO                           
\alt SHORT\_CENTI                          
\alt SHORT\_MILLI                          
\alt SHORT\_MICRO                          
\alt SHORT\_NANO                           
\alt SHORT\_PICO                           
                              
\end{grammar}
}


\subsection{Future Extensibility}
Function call defintoins

% {xyz}  Builtin Constant 
% {$xyz} Parameter/State
% {@xyz} Parameter [for function call]
% {~xyz} units








\newpage
\section{Examples}
\subsection{Valid Units}
\verbatiminput{../../src/testing/validunits.txt}

\subsection{Valid Expressions}
\verbatiminput{../../src/testing/validexpressions.txt}


\subsection{Invalid Expressions}



\end{document}
